{{define "title"}}Settings - Twitch Points Miner{{end}}

{{define "content"}}
<h1 class="text-3xl font-bold mb-2">Settings</h1>
<p class="text-twitch-muted text-sm mb-6">Configure runtime settings. Changes take effect immediately.</p>

<form id="settings-form" class="space-y-4">
    <details id="streamers" class="details-panel" open>
        <summary class="text-lg">Streamers</summary>
        <div class="details-content">
            <p class="text-twitch-muted text-sm mb-4">Manage streamers to track. Drag to reorder. Click to expand per-streamer settings.</p>
            
            <div class="flex gap-3 mb-4">
                <input type="text" id="new-streamer-input" placeholder="Enter streamer username" class="input-field flex-1">
                <button type="button" id="add-streamer-btn" class="btn-secondary whitespace-nowrap">Add Streamer</button>
            </div>
            
            <ul class="space-y-2" id="streamer-list">
            </ul>
        </div>
    </details>

    <details id="defaults" class="details-panel">
        <summary class="text-lg">Default Streamer Settings</summary>
        <div class="details-content">
            <p class="text-twitch-muted text-sm mb-4">These settings apply to all streamers unless overridden individually.</p>
            <div id="default-settings-container"></div>
        </div>
    </details>

    <details id="priority" class="details-panel">
        <summary class="text-lg">Priority Order</summary>
        <div class="details-content">
            <p class="text-twitch-muted text-sm mb-4">Drag to reorder. Higher priority items are checked first when selecting which stream to watch.</p>
            <ul class="space-y-2" id="priority-list">
            </ul>
        </div>
    </details>

    <details id="ratelimits" class="details-panel">
        <summary class="text-lg">Rate Limits</summary>
        <div class="details-content space-y-0">
            <div class="setting-row">
                <div>
                    <div class="setting-label">Websocket Ping Interval</div>
                    <div class="setting-description">Seconds between websocket ping messages (20-60)</div>
                </div>
                <input type="number" class="input-field w-28" id="websocketPingInterval" min="20" max="60">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Campaign Sync Interval</div>
                    <div class="setting-description">Seconds between drop campaign syncs (5-120)</div>
                </div>
                <input type="number" class="input-field w-28" id="campaignSyncInterval" min="5" max="120">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Minute Watched Interval</div>
                    <div class="setting-description">Base seconds between minute watched cycles (30-120, divided by # of streamers)</div>
                </div>
                <input type="number" class="input-field w-28" id="minuteWatchedInterval" min="30" max="120">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Request Delay</div>
                    <div class="setting-description">Seconds delay between API requests (0.1-2.0)</div>
                </div>
                <input type="number" class="input-field w-28" id="requestDelay" min="0.1" max="2.0" step="0.1">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Reconnect Delay</div>
                    <div class="setting-description">Seconds to wait before reconnecting (30-300)</div>
                </div>
                <input type="number" class="input-field w-28" id="reconnectDelay" min="30" max="300">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Stream Check Interval</div>
                    <div class="setting-description">Seconds between stream online checks (60-900)</div>
                </div>
                <input type="number" class="input-field w-28" id="streamCheckInterval" min="60" max="900">
            </div>
        </div>
    </details>

    <details id="logger" class="details-panel">
        <summary class="text-lg">Logger</summary>
        <div class="details-content space-y-0">
            <div class="setting-row">
                <div>
                    <div class="setting-label">Console Log Level</div>
                    <div class="setting-description">Minimum log level shown in console</div>
                </div>
                <select class="input-field w-36" id="consoleLevel">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">File Log Level</div>
                    <div class="setting-description">Minimum log level saved to file</div>
                </div>
                <select class="input-field w-36" id="fileLevel">
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARN">WARN</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Less Verbose</div>
                    <div class="setting-description">Reduce log output verbosity</div>
                </div>
                <input type="checkbox" id="less" class="w-5 h-5 accent-twitch">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Colored Output</div>
                    <div class="setting-description">Enable colored console output</div>
                </div>
                <input type="checkbox" id="colored" class="w-5 h-5 accent-twitch">
            </div>
        </div>
    </details>

    <details id="analytics" class="details-panel">
        <summary class="text-lg">Analytics</summary>
        <div class="details-content space-y-0">
            <div class="setting-row">
                <div>
                    <div class="setting-label">Refresh Interval</div>
                    <div class="setting-description">Minutes between dashboard auto-refresh</div>
                </div>
                <input type="number" class="input-field w-28" id="refresh" min="1" max="60">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Days of History</div>
                    <div class="setting-description">Number of days to show in charts</div>
                </div>
                <input type="number" class="input-field w-28" id="daysAgo" min="1" max="365">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Enable Chat Logs</div>
                    <div class="setting-description">Log chat messages to database</div>
                </div>
                <input type="checkbox" id="enableChatLogs" class="w-5 h-5 accent-twitch">
            </div>
        </div>
    </details>

    <details id="discord-settings" class="details-panel">
        <summary class="text-lg">Discord Integration</summary>
        <div class="details-content">
            <p class="text-twitch-muted text-sm mb-4">Configure Discord notifications. You'll need to create a Discord bot and add it to your server.</p>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Enable Discord Notifications</div>
                    <div class="setting-description">Turn on Discord integration (requires restart after enabling)</div>
                </div>
                <input type="checkbox" id="discordEnabled" class="w-5 h-5 accent-twitch">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Bot Token</div>
                    <div class="setting-description">Your Discord bot token (keep this secret!)</div>
                </div>
                <input type="password" class="input-field w-72" id="discordBotToken" placeholder="••••••••">
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Guild ID</div>
                    <div class="setting-description">Your Discord server ID</div>
                </div>
                <input type="text" class="input-field w-52" id="discordGuildId" placeholder="123456789012345678">
            </div>
            
            <div class="bg-twitch-bg border border-twitch-border rounded-lg p-4 mt-4">
                <div class="text-twitch-text font-medium mb-3">How to create a Discord bot:</div>
                <ol class="text-twitch-muted text-sm space-y-1 list-decimal pl-5">
                    <li>Go to the <a href="https://discord.com/developers/applications" target="_blank" class="text-twitch hover:underline">Discord Developer Portal</a></li>
                    <li>Click <strong class="text-twitch-text">New Application</strong> and give it a name</li>
                    <li>Go to <strong class="text-twitch-text">Bot</strong> section → Click <strong class="text-twitch-text">Reset Token</strong> and copy it</li>
                    <li>Enable <strong class="text-twitch-text">Message Content Intent</strong> under Privileged Gateway Intents</li>
                    <li>Go to <strong class="text-twitch-text">OAuth2 → URL Generator</strong></li>
                    <li>Select <strong class="text-twitch-text">bot</strong> scope with <strong class="text-twitch-text">Send Messages</strong> and <strong class="text-twitch-text">Read Message History</strong> permissions</li>
                    <li>Copy the generated URL and open it to add the bot to your server</li>
                </ol>
                <div class="text-twitch-text font-medium mt-4 mb-2">How to find your Guild (Server) ID:</div>
                <p class="text-twitch-muted text-sm">
                    See <a href="https://support.discord.com/hc/en-us/articles/206346498-Where-can-I-find-my-User-Server-Message-ID" target="_blank" class="text-twitch hover:underline">Discord's guide</a> on finding your Server ID.
                </p>
            </div>
        </div>
    </details>

    <div class="flex gap-4 justify-end pt-4">
        <button type="button" class="btn-secondary" id="reset-btn">Reset to Defaults</button>
        <button type="submit" class="btn-primary" id="save-btn">Save Settings</button>
    </div>
</form>

<div id="toast-container"></div>
{{end}}

{{define "scripts"}}
<script>
    const priorityLabels = {
        'STREAK': 'Watch Streak',
        'DROPS': 'Drops',
        'ORDER': 'Config Order',
        'SUBSCRIBED': 'Subscribed Channels',
        'POINTS_ASCENDING': 'Points (Lowest First)',
        'POINTS_DESCENDING': 'Points (Highest First)'
    };

    const chatOptions = [
        { value: 'ONLINE', label: 'When Online' },
        { value: 'OFFLINE', label: 'When Offline' },
        { value: 'ALWAYS', label: 'Always' },
        { value: 'NEVER', label: 'Never' }
    ];

    const strategyOptions = [
        { value: 'SMART', label: 'Smart' },
        { value: 'MOST_VOTED', label: 'Most Voted' },
        { value: 'HIGH_ODDS', label: 'High Odds' },
        { value: 'PERCENTAGE', label: 'Percentage' },
        { value: 'SMART_MONEY', label: 'Smart Money' },
        { value: 'NUMBER_1', label: 'Always #1' },
        { value: 'NUMBER_2', label: 'Always #2' }
    ];

    const delayModeOptions = [
        { value: 'FROM_END', label: 'From End' },
        { value: 'FROM_START', label: 'From Start' },
        { value: 'PERCENTAGE', label: 'Percentage' }
    ];

    let currentSettings = null;

    async function loadSettings() {
        try {
            const response = await fetch('/api/settings');
            if (!response.ok) throw new Error('Failed to load settings');
            currentSettings = await response.json();
            populateForm(currentSettings);
        } catch (error) {
            showToast('Failed to load settings', 'error');
            console.error(error);
        }
    }

    function populateForm(settings) {
        populateStreamerList(settings.streamers || []);
        
        const defaultContainer = document.getElementById('default-settings-container');
        defaultContainer.innerHTML = renderStreamerSettingsForm('default', settings.defaultSettings || {}, false);

        const priorityList = document.getElementById('priority-list');
        priorityList.innerHTML = '';
        settings.priority.forEach(p => {
            const li = document.createElement('li');
            li.className = 'priority-item';
            li.draggable = true;
            li.dataset.priority = p;
            li.innerHTML = `<span class="text-twitch-muted text-lg cursor-grab">☰</span> <span class="text-twitch-text">${priorityLabels[p] || p}</span>`;
            priorityList.appendChild(li);
        });
        setupPriorityDragAndDrop();

        document.getElementById('websocketPingInterval').value = settings.rateLimits.websocketPingInterval;
        document.getElementById('campaignSyncInterval').value = settings.rateLimits.campaignSyncInterval;
        document.getElementById('minuteWatchedInterval').value = settings.rateLimits.minuteWatchedInterval;
        document.getElementById('requestDelay').value = settings.rateLimits.requestDelay;
        document.getElementById('reconnectDelay').value = settings.rateLimits.reconnectDelay;
        document.getElementById('streamCheckInterval').value = settings.rateLimits.streamCheckInterval;

        document.getElementById('consoleLevel').value = settings.logger.consoleLevel;
        document.getElementById('fileLevel').value = settings.logger.fileLevel;
        document.getElementById('less').checked = settings.logger.less;
        document.getElementById('colored').checked = settings.logger.colored;

        document.getElementById('refresh').value = settings.analytics.refresh;
        document.getElementById('daysAgo').value = settings.analytics.daysAgo;
        document.getElementById('enableChatLogs').checked = settings.analytics.enableChatLogs;

        if (settings.discord) {
            document.getElementById('discordEnabled').checked = settings.discord.enabled;
            document.getElementById('discordBotToken').value = settings.discord.botToken || '';
            document.getElementById('discordGuildId').value = settings.discord.guildId || '';
        }
    }

    function populateStreamerList(streamers) {
        const list = document.getElementById('streamer-list');
        list.innerHTML = '';
        streamers.forEach((s, index) => {
            const li = createStreamerItem(s, index);
            list.appendChild(li);
        });
        setupStreamerDragAndDrop();
    }

    function createStreamerItem(streamer, index) {
        const li = document.createElement('li');
        li.className = 'streamer-item';
        li.draggable = true;
        li.dataset.index = index;
        li.dataset.username = streamer.username;

        const hasOverrides = streamer.settings && Object.keys(streamer.settings).length > 0;
        
        li.innerHTML = `
            <div class="streamer-header" onclick="toggleStreamerExpand(this.parentElement)">
                <div class="text-twitch-muted text-lg cursor-grab">☰</div>
                <span class="flex-1 text-twitch-text font-medium">${streamer.username}</span>
                ${hasOverrides ? '<span class="override-badge">Custom</span>' : ''}
                <span class="text-twitch-muted text-xs transition-transform duration-200 expand-icon">▼</span>
                <button type="button" class="ml-2 px-2 py-1 text-twitch-muted hover:text-twitch-live hover:bg-twitch-live/10 rounded transition-colors" onclick="event.stopPropagation(); removeStreamer('${streamer.username}')">✕</button>
            </div>
            <div class="hidden border-t border-twitch-border bg-twitch-card settings-panel">
                <div class="p-4 border-b border-twitch-border">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" class="w-5 h-5 accent-twitch use-override-checkbox" ${hasOverrides ? 'checked' : ''} 
                               onchange="toggleOverride(this, '${streamer.username}')">
                        <span class="text-twitch-text">Use custom settings for this streamer</span>
                    </label>
                </div>
                <div class="p-4 settings-content" style="${hasOverrides ? '' : 'display: none;'}">
                    ${renderStreamerSettingsForm(streamer.username, streamer.settings || {}, true)}
                </div>
            </div>
        `;
        return li;
    }

    function renderStreamerSettingsForm(prefix, settings, isOverride) {
        const bet = settings.bet || {};
        const checkboxAttrs = (field, value) => {
            if (value === undefined || value === null) return '';
            return value ? 'checked' : '';
        };
        const selectValue = (field, value, defaultVal) => value !== undefined && value !== null ? value : defaultVal;

        return `
            <div class="space-y-0">
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Make Predictions</div>
                        <div class="setting-description">Automatically bet on predictions</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="makePredictions" data-prefix="${prefix}" ${checkboxAttrs('makePredictions', settings.makePredictions)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Follow Raid</div>
                        <div class="setting-description">Follow when streamer raids another channel</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="followRaid" data-prefix="${prefix}" ${checkboxAttrs('followRaid', settings.followRaid)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Claim Drops</div>
                        <div class="setting-description">Automatically claim drop rewards</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="claimDrops" data-prefix="${prefix}" ${checkboxAttrs('claimDrops', settings.claimDrops)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Claim Moments</div>
                        <div class="setting-description">Claim channel moments</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="claimMoments" data-prefix="${prefix}" ${checkboxAttrs('claimMoments', settings.claimMoments)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Watch Streak</div>
                        <div class="setting-description">Maintain watch streak bonus</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="watchStreak" data-prefix="${prefix}" ${checkboxAttrs('watchStreak', settings.watchStreak)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Community Goals</div>
                        <div class="setting-description">Contribute to community goals</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="communityGoals" data-prefix="${prefix}" ${checkboxAttrs('communityGoals', settings.communityGoals)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Chat Presence</div>
                        <div class="setting-description">When to join chat</div>
                    </div>
                    <select class="input-field w-36" data-field="chat" data-prefix="${prefix}">
                        ${chatOptions.map(o => `<option value="${o.value}" ${selectValue('chat', settings.chat, 'ONLINE') === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>
                
                <h4 class="text-twitch font-medium mt-6 mb-4 text-sm">Betting Settings</h4>
                
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Strategy</div>
                        <div class="setting-description">How to choose prediction outcome</div>
                    </div>
                    <select class="input-field w-36" data-field="bet.strategy" data-prefix="${prefix}">
                        ${strategyOptions.map(o => `<option value="${o.value}" ${selectValue('strategy', bet.strategy, 'SMART') === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Bet Percentage</div>
                        <div class="setting-description">Percentage of points to bet (1-100)</div>
                    </div>
                    <input type="number" class="input-field w-28" data-field="bet.percentage" data-prefix="${prefix}" min="1" max="100" value="${bet.percentage !== undefined ? bet.percentage : 5}">
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Percentage Gap</div>
                        <div class="setting-description">Gap threshold for smart strategy</div>
                    </div>
                    <input type="number" class="input-field w-28" data-field="bet.percentageGap" data-prefix="${prefix}" min="0" max="100" value="${bet.percentageGap !== undefined ? bet.percentageGap : 20}">
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Max Points</div>
                        <div class="setting-description">Maximum points to bet</div>
                    </div>
                    <input type="number" class="input-field w-28" data-field="bet.maxPoints" data-prefix="${prefix}" min="0" value="${bet.maxPoints !== undefined ? bet.maxPoints : 50000}">
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Minimum Points</div>
                        <div class="setting-description">Minimum balance required to bet</div>
                    </div>
                    <input type="number" class="input-field w-28" data-field="bet.minimumPoints" data-prefix="${prefix}" min="0" value="${bet.minimumPoints !== undefined ? bet.minimumPoints : 0}">
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Stealth Mode</div>
                        <div class="setting-description">Bet slightly less than top predictor</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-twitch" data-field="bet.stealthMode" data-prefix="${prefix}" ${checkboxAttrs('stealthMode', bet.stealthMode)}>
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Delay</div>
                        <div class="setting-description">Seconds to wait before betting</div>
                    </div>
                    <input type="number" class="input-field w-28" data-field="bet.delay" data-prefix="${prefix}" min="0" step="0.5" value="${bet.delay !== undefined ? bet.delay : 6}">
                </div>
                <div class="setting-row">
                    <div>
                        <div class="setting-label">Delay Mode</div>
                        <div class="setting-description">How delay is calculated</div>
                    </div>
                    <select class="input-field w-36" data-field="bet.delayMode" data-prefix="${prefix}">
                        ${delayModeOptions.map(o => `<option value="${o.value}" ${selectValue('delayMode', bet.delayMode, 'FROM_END') === o.value ? 'selected' : ''}>${o.label}</option>`).join('')}
                    </select>
                </div>
            </div>
        `;
    }

    function toggleStreamerExpand(li) {
        const panel = li.querySelector('.settings-panel');
        const icon = li.querySelector('.expand-icon');
        panel.classList.toggle('hidden');
        icon.style.transform = panel.classList.contains('hidden') ? '' : 'rotate(180deg)';
    }

    function toggleOverride(checkbox, username) {
        const panel = checkbox.closest('.settings-panel');
        const content = panel.querySelector('.settings-content');
        content.style.display = checkbox.checked ? '' : 'none';
    }

    function addStreamer() {
        const input = document.getElementById('new-streamer-input');
        const username = input.value.trim().toLowerCase();
        if (!username) {
            showToast('Please enter a username', 'error');
            return;
        }

        const existing = document.querySelector(`.streamer-item[data-username="${username}"]`);
        if (existing) {
            showToast('Streamer already exists', 'error');
            return;
        }

        const list = document.getElementById('streamer-list');
        const index = list.children.length;
        const li = createStreamerItem({ username, settings: null }, index);
        list.appendChild(li);
        setupStreamerDragAndDrop();
        input.value = '';
        showToast(`Added ${username}`);
    }

    function removeStreamer(username) {
        if (!confirm(`Remove ${username}?`)) return;
        const item = document.querySelector(`.streamer-item[data-username="${username}"]`);
        if (item) {
            item.remove();
            showToast(`Removed ${username}`);
        }
    }

    function gatherStreamerSettings(prefix) {
        const settings = {};
        const inputs = document.querySelectorAll(`[data-prefix="${prefix}"]`);
        
        inputs.forEach(input => {
            const field = input.dataset.field;
            let value;
            
            if (input.type === 'checkbox') {
                value = input.checked;
            } else if (input.type === 'number') {
                value = input.step && input.step !== '1' ? parseFloat(input.value) : parseInt(input.value);
            } else {
                value = input.value;
            }
            
            if (field.startsWith('bet.')) {
                if (!settings.bet) settings.bet = {};
                settings.bet[field.substring(4)] = value;
            } else {
                settings[field] = value;
            }
        });
        
        return settings;
    }

    function gatherStreamers() {
        const items = document.querySelectorAll('.streamer-item');
        const streamers = [];
        
        items.forEach(item => {
            const username = item.dataset.username;
            const useOverride = item.querySelector('.use-override-checkbox').checked;
            
            const streamer = { username };
            if (useOverride) {
                streamer.settings = gatherStreamerSettings(username);
            }
            streamers.push(streamer);
        });
        
        return streamers;
    }

    function gatherFormData() {
        const priorityItems = document.querySelectorAll('.priority-item');
        const priority = Array.from(priorityItems).map(item => item.dataset.priority);

        return {
            streamers: gatherStreamers(),
            defaultSettings: gatherStreamerSettings('default'),
            priority: priority,
            rateLimits: {
                websocketPingInterval: parseInt(document.getElementById('websocketPingInterval').value),
                campaignSyncInterval: parseInt(document.getElementById('campaignSyncInterval').value),
                minuteWatchedInterval: parseInt(document.getElementById('minuteWatchedInterval').value),
                requestDelay: parseFloat(document.getElementById('requestDelay').value),
                reconnectDelay: parseInt(document.getElementById('reconnectDelay').value),
                streamCheckInterval: parseInt(document.getElementById('streamCheckInterval').value)
            },
            logger: {
                consoleLevel: document.getElementById('consoleLevel').value,
                fileLevel: document.getElementById('fileLevel').value,
                less: document.getElementById('less').checked,
                colored: document.getElementById('colored').checked
            },
            analytics: {
                refresh: parseInt(document.getElementById('refresh').value),
                daysAgo: parseInt(document.getElementById('daysAgo').value),
                enableChatLogs: document.getElementById('enableChatLogs').checked
            },
            discord: {
                enabled: document.getElementById('discordEnabled').checked,
                botToken: document.getElementById('discordBotToken').value,
                guildId: document.getElementById('discordGuildId').value
            }
        };
    }

    function setupPriorityDragAndDrop() {
        const list = document.getElementById('priority-list');
        setupDragAndDropForList(list, '.priority-item');
    }

    function setupStreamerDragAndDrop() {
        const list = document.getElementById('streamer-list');
        setupDragAndDropForList(list, '.streamer-item');
    }

    function setupDragAndDropForList(list, itemSelector) {
        let draggedItem = null;

        list.querySelectorAll(itemSelector).forEach(item => {
            item.addEventListener('dragstart', (e) => {
                draggedItem = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                draggedItem = null;
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (draggedItem && draggedItem !== item) {
                    const rect = item.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        list.insertBefore(draggedItem, item);
                    } else {
                        list.insertBefore(draggedItem, item.nextSibling);
                    }
                }
            });
        });
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    document.getElementById('add-streamer-btn').addEventListener('click', addStreamer);
    document.getElementById('new-streamer-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            addStreamer();
        }
    });

    document.getElementById('settings-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        const oldDiscordEnabled = currentSettings?.discord?.enabled || false;

        try {
            const data = gatherFormData();
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error);
            }

            const newDiscordEnabled = data.discord?.enabled || false;
            
            if (oldDiscordEnabled !== newDiscordEnabled) {
                showToast('Settings saved! Reloading...');
                sessionStorage.removeItem('miner_loaded_' + window.location.pathname);
                setTimeout(() => window.location.reload(), 500);
                return;
            }

            showToast('Settings saved successfully!');
            currentSettings = data;
        } catch (error) {
            showToast(error.message || 'Failed to save settings', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Settings';
        }
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
        if (!confirm('Reset all settings to defaults? This will NOT remove streamers.')) return;

        try {
            const response = await fetch('/api/settings/reset', { method: 'POST' });
            if (!response.ok) throw new Error('Failed to reset');
            
            const settings = await response.json();
            populateForm(settings);
            showToast('Settings reset to defaults');
        } catch (error) {
            showToast('Failed to reset settings', 'error');
        }
    });

    loadSettings();
</script>
{{end}}
