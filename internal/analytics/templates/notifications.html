{{define "title"}}Notifications - Twitch Points Miner{{end}}

{{define "content"}}
<h1 class="text-3xl font-bold mb-6">Notifications</h1>

{{if not .ConfigValid}}
<article class="card border-red-500 bg-red-500/10 mb-6">
    <div class="flex items-center gap-2 mb-2">
        <span class="text-red-500 font-semibold">⚠️ Configuration Error</span>
    </div>
    <p class="text-neutral-400 mb-2">{{.ConfigError}}</p>
    <p><a href="/settings" class="text-purple-500 hover:underline">Go to Settings</a> to configure Discord integration.</p>
</article>
{{end}}

<div id="notifications-app" class="space-y-4 {{if not .ConfigValid}}opacity-50 pointer-events-none{{end}}">
    <details id="notif-channels" class="details-panel">
        <summary class="text-lg">Discord Channels</summary>
        <div class="details-content">
            <p class="text-neutral-400 text-sm mb-4">Select which Discord channel each notification type should be sent to.</p>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Mentions Channel</div>
                    <div class="setting-description">Channel for chat mention notifications</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" class="channel-reload-btn p-2 border border-neutral-700 rounded hover:border-purple-500 hover:text-purple-400 transition-colors" onclick="reloadChannels()" title="Reload channels" {{if not .ConfigValid}}disabled{{end}}>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <select class="input-field w-64 channel-select" id="mentions-channel" {{if not .ConfigValid}}disabled{{end}}>
                        <option value="">-- Select Channel --</option>
                    </select>
                    <div class="channel-loading w-5 h-5 border-2 border-neutral-700 border-t-purple-500 rounded-full animate-spin hidden"></div>
                </div>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Points Channel</div>
                    <div class="setting-description">Channel for point threshold notifications</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" class="channel-reload-btn p-2 border border-neutral-700 rounded hover:border-purple-500 hover:text-purple-400 transition-colors" onclick="reloadChannels()" title="Reload channels" {{if not .ConfigValid}}disabled{{end}}>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <select class="input-field w-64 channel-select" id="points-channel" {{if not .ConfigValid}}disabled{{end}}>
                        <option value="">-- Select Channel --</option>
                    </select>
                    <div class="channel-loading w-5 h-5 border-2 border-neutral-700 border-t-purple-500 rounded-full animate-spin hidden"></div>
                </div>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Online Channel</div>
                    <div class="setting-description">Channel for streamer online notifications</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" class="channel-reload-btn p-2 border border-neutral-700 rounded hover:border-purple-500 hover:text-purple-400 transition-colors" onclick="reloadChannels()" title="Reload channels" {{if not .ConfigValid}}disabled{{end}}>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <select class="input-field w-64 channel-select" id="online-channel" {{if not .ConfigValid}}disabled{{end}}>
                        <option value="">-- Select Channel --</option>
                    </select>
                    <div class="channel-loading w-5 h-5 border-2 border-neutral-700 border-t-purple-500 rounded-full animate-spin hidden"></div>
                </div>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Offline Channel</div>
                    <div class="setting-description">Channel for streamer offline notifications</div>
                </div>
                <div class="flex items-center gap-2">
                    <button type="button" class="channel-reload-btn p-2 border border-neutral-700 rounded hover:border-purple-500 hover:text-purple-400 transition-colors" onclick="reloadChannels()" title="Reload channels" {{if not .ConfigValid}}disabled{{end}}>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                    <select class="input-field w-64 channel-select" id="offline-channel" {{if not .ConfigValid}}disabled{{end}}>
                        <option value="">-- Select Channel --</option>
                    </select>
                    <div class="channel-loading w-5 h-5 border-2 border-neutral-700 border-t-purple-500 rounded-full animate-spin hidden"></div>
                </div>
            </div>
        </div>
    </details>

    <details id="notif-mentions" class="details-panel">
        <summary class="text-lg">Chat Mentions</summary>
        <div class="details-content">
            <p class="text-neutral-400 text-sm mb-4">Get notified when someone mentions you in chat.</p>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">Enable Mention Notifications</div>
                    <div class="setting-description">Receive notifications when mentioned in chat</div>
                </div>
                <input type="checkbox" class="w-5 h-5 accent-purple-600" id="mentions-enabled" {{if not .ConfigValid}}disabled{{end}}>
            </div>
            
            <div class="setting-row">
                <div>
                    <div class="setting-label">All Chats</div>
                    <div class="setting-description">Notify for mentions in all tracked streams</div>
                </div>
                <input type="checkbox" class="w-5 h-5 accent-purple-600" id="mentions-all-chats" {{if not .ConfigValid}}disabled{{end}}>
            </div>
            
            <div class="setting-row flex-col items-start gap-2 hidden" id="mentions-streamers-row">
                <div>
                    <div class="setting-label">Selected Streamers</div>
                    <div class="setting-description">Only notify for mentions in these chats</div>
                </div>
                <div class="flex flex-wrap gap-2 mt-2" id="mentions-streamers">
                    {{range .Streamers}}
                    <label class="flex items-center gap-1 bg-neutral-900 px-2 py-1 rounded border border-neutral-700 text-sm cursor-pointer hover:border-purple-500 transition-colors">
                        <input type="checkbox" class="w-4 h-4 accent-purple-600" value="{{.}}" {{if not $.ConfigValid}}disabled{{end}}>
                        <span>{{.}}</span>
                    </label>
                    {{end}}
                </div>
            </div>
        </div>
    </details>

    <details id="notif-points" class="details-panel">
        <summary class="text-lg">Point Goals</summary>
        <div class="details-content">
            <p class="text-neutral-400 text-sm mb-4">Get notified when you reach a point threshold in a channel.</p>
            
            <div class="flex flex-wrap gap-3 items-center mb-4">
                <select id="point-rule-streamer" class="input-field w-52" {{if not .ConfigValid}}disabled{{end}}>
                    {{range .Streamers}}
                    <option value="{{.}}">{{.}}</option>
                    {{end}}
                </select>
                <input type="number" id="point-rule-threshold" placeholder="Point threshold" min="1" class="input-field w-48" {{if not .ConfigValid}}disabled{{end}}>
                <label class="flex items-center gap-2 text-neutral-400 text-sm whitespace-nowrap">
                    <input type="checkbox" class="w-4 h-4 accent-purple-600" id="point-rule-delete" {{if not .ConfigValid}}disabled{{end}}>
                    <span>Delete after trigger</span>
                </label>
                <button type="button" id="add-point-rule-btn" class="btn-secondary" {{if not .ConfigValid}}disabled{{end}}>Add Rule</button>
            </div>
            
            <table class="w-full" id="point-rules-table">
                <thead>
                    <tr>
                        <th>Streamer</th>
                        <th>Threshold</th>
                        <th>One-time</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="point-rules-body">
                </tbody>
            </table>
        </div>
    </details>

    <details id="notif-stream-status" class="details-panel">
        <summary class="text-lg">Stream Status</summary>
        <div class="details-content">
            <p class="text-neutral-400 text-sm mb-4">Get notified when streamers go online or offline.</p>
            
            <div class="bg-neutral-900 rounded-lg p-4 mb-4">
                <div class="setting-row border-b-0">
                    <div>
                        <div class="setting-label">Enable Online Notifications</div>
                        <div class="setting-description">Receive notifications when streamers go live</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-purple-600" id="online-enabled" {{if not .ConfigValid}}disabled{{end}}>
                </div>
                
                <div id="online-options" class="hidden mt-3 pl-4 border-l-2 border-purple-500/30 space-y-3">
                    <div class="setting-row border-b-0 py-2">
                        <div>
                            <div class="setting-label">All Streamers</div>
                            <div class="setting-description">Notify for all tracked streamers</div>
                        </div>
                        <input type="checkbox" class="w-5 h-5 accent-purple-600" id="online-all-streamers" {{if not .ConfigValid}}disabled{{end}}>
                    </div>
                    
                    <div class="hidden py-2" id="online-streamers-row">
                        <div class="mb-2">
                            <div class="setting-label">Selected Streamers</div>
                            <div class="setting-description">Only notify for these streamers</div>
                        </div>
                        <div class="flex flex-wrap gap-2" id="online-streamers">
                            {{range .Streamers}}
                            <label class="flex items-center gap-1 bg-neutral-800 px-2 py-1 rounded border border-neutral-700 text-sm cursor-pointer hover:border-purple-500 transition-colors">
                                <input type="checkbox" class="w-4 h-4 accent-purple-600" value="{{.}}" {{if not $.ConfigValid}}disabled{{end}}>
                                <span>{{.}}</span>
                            </label>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-neutral-900 rounded-lg p-4">
                <div class="setting-row border-b-0">
                    <div>
                        <div class="setting-label">Enable Offline Notifications</div>
                        <div class="setting-description">Receive notifications when streamers go offline</div>
                    </div>
                    <input type="checkbox" class="w-5 h-5 accent-purple-600" id="offline-enabled" {{if not .ConfigValid}}disabled{{end}}>
                </div>
                
                <div id="offline-options" class="hidden mt-3 pl-4 border-l-2 border-purple-500/30 space-y-3">
                    <div class="setting-row border-b-0 py-2">
                        <div>
                            <div class="setting-label">All Streamers</div>
                            <div class="setting-description">Notify for all tracked streamers</div>
                        </div>
                        <input type="checkbox" class="w-5 h-5 accent-purple-600" id="offline-all-streamers" {{if not .ConfigValid}}disabled{{end}}>
                    </div>
                    
                    <div class="hidden py-2" id="offline-streamers-row">
                        <div class="mb-2">
                            <div class="setting-label">Selected Streamers</div>
                            <div class="setting-description">Only notify for these streamers</div>
                        </div>
                        <div class="flex flex-wrap gap-2" id="offline-streamers">
                            {{range .Streamers}}
                            <label class="flex items-center gap-1 bg-neutral-800 px-2 py-1 rounded border border-neutral-700 text-sm cursor-pointer hover:border-purple-500 transition-colors">
                                <input type="checkbox" class="w-4 h-4 accent-purple-600" value="{{.}}" {{if not $.ConfigValid}}disabled{{end}}>
                                <span>{{.}}</span>
                            </label>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </details>

    <div class="flex gap-4 justify-end pt-4">
        <button type="button" class="btn-secondary" id="test-notifications-btn" onclick="testNotifications()" {{if not .ConfigValid}}disabled{{end}}>Test All Notifications</button>
        <button type="button" class="btn-primary" id="save-notifications-btn" {{if not .ConfigValid}}disabled{{end}}>Save Settings</button>
    </div>
</div>

<div id="toast-container"></div>
{{end}}

{{define "scripts"}}
<script>
    let channels = [];
    let config = null;
    let pointRules = [];
    let channelsLoaded = false;
    const configValid = {{.ConfigValid}};

    function showChannelLoading(show) {
        document.querySelectorAll('.channel-loading').forEach(el => {
            el.classList.toggle('hidden', !show);
        });
    }

    function showChannelError(message) {
        document.querySelectorAll('.channel-loading').forEach(el => {
            el.classList.add('hidden');
        });
    }

    async function reloadChannels() {
        const buttons = document.querySelectorAll('.channel-reload-btn');
        buttons.forEach(btn => {
            btn.classList.add('animate-spin');
            btn.disabled = true;
        });
        
        channelsLoaded = false;
        channels = [];
        
        try {
            await loadChannels(true);
        } finally {
            buttons.forEach(btn => {
                btn.classList.remove('animate-spin');
                btn.disabled = false;
            });
        }
    }

    async function loadChannels(forceRefresh = false) {
        if (!configValid) {
            showChannelLoading(false);
            return;
        }
        
        showChannelLoading(true);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        try {
            const url = forceRefresh ? '/api/notifications/channels?refresh=1' : '/api/notifications/channels';
            const response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            
            if (response.ok) {
                channels = await response.json();
                channelsLoaded = true;
                showChannelLoading(false);
                populateChannelSelects();
            } else {
                showChannelError('Failed to load');
            }
        } catch (error) {
            clearTimeout(timeoutId);
            showChannelError('Error');
            console.error('Failed to load channels:', error);
        }
    }

    function populateChannelSelects() {
        const selects = document.querySelectorAll('.channel-select');
        selects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Channel --</option>';
            channels.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch.id;
                option.textContent = '#' + ch.name;
                select.appendChild(option);
            });
            select.value = currentValue;
        });
    }

    async function loadConfig() {
        if (!configValid) return;
        
        try {
            const response = await fetch('/api/notifications/config');
            if (response.ok) {
                config = await response.json();
                applyConfig();
            }
        } catch (error) {
            console.error('Failed to load config:', error);
        }
    }

    function applyConfig() {
        if (!config) return;

        document.getElementById('mentions-channel').value = config.mentionsChannelId || '';
        document.getElementById('points-channel').value = config.pointsChannelId || '';
        document.getElementById('online-channel').value = config.onlineChannelId || '';
        document.getElementById('offline-channel').value = config.offlineChannelId || '';

        document.getElementById('mentions-enabled').checked = config.mentionsEnabled;
        document.getElementById('mentions-all-chats').checked = config.mentionsAllChats;
        toggleStreamerSelect('mentions');

        document.getElementById('online-enabled').checked = config.onlineEnabled;
        document.getElementById('online-all-streamers').checked = config.onlineAllStreamers;
        toggleOnlineOptions();
        toggleStreamerSelect('online');

        document.getElementById('offline-enabled').checked = config.offlineEnabled;
        document.getElementById('offline-all-streamers').checked = config.offlineAllStreamers;
        toggleOfflineOptions();
        toggleStreamerSelect('offline');

        applyStreamerCheckboxes('mentions', config.mentionsStreamers || []);
        applyStreamerCheckboxes('online', config.onlineStreamers || []);
        applyStreamerCheckboxes('offline', config.offlineStreamers || []);
    }

    function applyStreamerCheckboxes(prefix, selected) {
        const container = document.getElementById(prefix + '-streamers');
        if (!container) return;
        
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = selected.includes(cb.value);
        });
    }

    function getSelectedStreamers(prefix) {
        const container = document.getElementById(prefix + '-streamers');
        if (!container) return [];
        
        const selected = [];
        container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            selected.push(cb.value);
        });
        return selected;
    }

    function toggleStreamerSelect(prefix) {
        const allCheckbox = document.getElementById(prefix + '-all-chats') || document.getElementById(prefix + '-all-streamers');
        const row = document.getElementById(prefix + '-streamers-row');
        if (allCheckbox && row) {
            row.classList.toggle('hidden', allCheckbox.checked);
        }
    }

    function toggleOnlineOptions() {
        const enabled = document.getElementById('online-enabled').checked;
        const options = document.getElementById('online-options');
        if (options) {
            options.classList.toggle('hidden', !enabled);
        }
    }

    function toggleOfflineOptions() {
        const enabled = document.getElementById('offline-enabled').checked;
        const options = document.getElementById('offline-options');
        if (options) {
            options.classList.toggle('hidden', !enabled);
        }
    }

    async function loadPointRules() {
        if (!configValid) return;
        
        try {
            const response = await fetch('/api/notifications/points');
            if (response.ok) {
                pointRules = await response.json() || [];
                renderPointRules();
            }
        } catch (error) {
            console.error('Failed to load point rules:', error);
        }
    }

    function renderPointRules() {
        const tbody = document.getElementById('point-rules-body');
        tbody.innerHTML = '';

        if (pointRules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-neutral-400 py-4">No point rules configured</td></tr>';
            return;
        }

        pointRules.forEach(rule => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${rule.streamer}</td>
                <td>${formatNumber(rule.threshold)}</td>
                <td>${rule.deleteOnTrigger ? 'Yes' : 'No'}</td>
                <td class="${rule.triggered ? 'text-green-500' : 'text-neutral-400'}">${rule.triggered ? 'Triggered' : 'Waiting'}</td>
                <td><button class="px-2 py-1 text-neutral-400 hover:text-red-500 hover:bg-red-500/10 rounded transition-colors" onclick="deletePointRule(${rule.id})">✕</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function formatNumber(n) {
        return new Intl.NumberFormat().format(n);
    }

    async function addPointRule() {
        const streamer = document.getElementById('point-rule-streamer').value;
        const threshold = parseInt(document.getElementById('point-rule-threshold').value);
        const deleteOnTrigger = document.getElementById('point-rule-delete').checked;

        if (!streamer || !threshold || threshold < 1) {
            showToast('Please enter a valid streamer and threshold', 'error');
            return;
        }

        try {
            const response = await fetch('/api/notifications/points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ streamer, threshold, deleteOnTrigger })
            });

            if (response.ok) {
                document.getElementById('point-rule-threshold').value = '';
                document.getElementById('point-rule-delete').checked = false;
                await loadPointRules();
                showToast('Point rule added');
            } else {
                showToast('Failed to add rule', 'error');
            }
        } catch (error) {
            showToast('Failed to add rule', 'error');
        }
    }

    async function deletePointRule(id) {
        if (!confirm('Delete this point rule?')) return;

        try {
            const response = await fetch(`/api/notifications/points/${id}`, { method: 'DELETE' });
            if (response.ok) {
                await loadPointRules();
                showToast('Rule deleted');
            } else {
                showToast('Failed to delete rule', 'error');
            }
        } catch (error) {
            showToast('Failed to delete rule', 'error');
        }
    }

    async function saveConfig() {
        const newConfig = {
            mentionsChannelId: document.getElementById('mentions-channel').value,
            pointsChannelId: document.getElementById('points-channel').value,
            onlineChannelId: document.getElementById('online-channel').value,
            offlineChannelId: document.getElementById('offline-channel').value,
            mentionsEnabled: document.getElementById('mentions-enabled').checked,
            mentionsAllChats: document.getElementById('mentions-all-chats').checked,
            mentionsStreamers: getSelectedStreamers('mentions'),
            onlineEnabled: document.getElementById('online-enabled').checked,
            onlineAllStreamers: document.getElementById('online-all-streamers').checked,
            onlineStreamers: getSelectedStreamers('online'),
            offlineEnabled: document.getElementById('offline-enabled').checked,
            offlineAllStreamers: document.getElementById('offline-all-streamers').checked,
            offlineStreamers: getSelectedStreamers('offline')
        };

        try {
            const response = await fetch('/api/notifications/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newConfig)
            });

            if (response.ok) {
                showToast('Settings saved!');
            } else {
                showToast('Failed to save settings', 'error');
            }
        } catch (error) {
            showToast('Failed to save settings', 'error');
        }
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    async function testNotifications() {
        const btn = document.getElementById('test-notifications-btn');
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Sending...';
        
        try {
            const response = await fetch('/api/notifications/test', { method: 'POST' });
            if (response.ok) {
                const result = await response.json();
                showToast(`Sent ${result.sent} test notifications`);
            } else {
                const error = await response.text();
                showToast('Failed: ' + error, 'error');
            }
        } catch (error) {
            showToast('Failed to send test notifications', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    document.getElementById('mentions-all-chats')?.addEventListener('change', () => toggleStreamerSelect('mentions'));
    document.getElementById('online-enabled')?.addEventListener('change', toggleOnlineOptions);
    document.getElementById('online-all-streamers')?.addEventListener('change', () => toggleStreamerSelect('online'));
    document.getElementById('offline-enabled')?.addEventListener('change', toggleOfflineOptions);
    document.getElementById('offline-all-streamers')?.addEventListener('change', () => toggleStreamerSelect('offline'));
    document.getElementById('add-point-rule-btn')?.addEventListener('click', addPointRule);
    document.getElementById('save-notifications-btn')?.addEventListener('click', saveConfig);

    // Persist details panel state
    document.querySelectorAll('details.details-panel').forEach(details => {
        const key = 'details_' + details.id;
        if (localStorage.getItem(key) === 'open') {
            details.open = true;
        }
        details.addEventListener('toggle', () => {
            localStorage.setItem(key, details.open ? 'open' : 'closed');
        });
    });

    loadConfig();
    loadPointRules();
    loadChannels().then(() => {
        if (config && channelsLoaded) {
            document.getElementById('mentions-channel').value = config.mentionsChannelId || '';
            document.getElementById('points-channel').value = config.pointsChannelId || '';
            document.getElementById('online-channel').value = config.onlineChannelId || '';
            document.getElementById('offline-channel').value = config.offlineChannelId || '';
        }
    });
</script>
{{end}}
