<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}Twitch Points Miner{{end}}</title>
    <link rel="stylesheet" href="/static/css/app.css">
    <script src="/static/js/htmx.min.js" defer></script>
    <script src="/static/js/apexcharts.min.js" defer></script>
</head>
<body class="min-h-screen bg-neutral-900 text-neutral-100 pb-16">
    <div id="status-overlay" class="status-overlay hidden fixed inset-0 bg-neutral-900/95 flex items-center justify-center z-[1000]">
        <div class="bg-neutral-800 border border-neutral-700 rounded-xl p-8 max-w-md w-[90%] text-center">
            <h2 id="status-title" class="text-purple-500 text-xl font-semibold mb-4">Initializing...</h2>
            <div class="w-12 h-12 border-4 border-neutral-700 border-t-purple-500 rounded-full animate-spin mx-auto my-6" id="status-spinner"></div>
            <div id="status-content"></div>
            <p class="text-neutral-400 mt-2 text-sm" id="status-message"></p>
        </div>
    </div>

    <nav class="bg-neutral-800 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex h-14 items-center justify-between">
                <a href="/" class="flex items-center gap-2 text-lg font-semibold text-white">
                    <img src="/static/images/icon.png" alt="Twitch Points Miner" class="w-8 h-8">
                    Twitch Points Miner
                </a>
                <div class="flex items-center gap-1">
                    <a href="/" class="px-3 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-700 hover:text-white rounded-md transition-colors">
                        Dashboard
                    </a>
                    {{if .DiscordEnabled}}
                    <a href="/notifications" class="px-3 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-700 hover:text-white rounded-md transition-colors">
                        Notifications
                    </a>
                    {{end}}
                    <a href="/settings" class="px-3 py-2 text-sm font-medium text-neutral-300 hover:bg-neutral-700 hover:text-white rounded-md transition-colors">
                        Settings
                    </a>
                </div>
                <div class="flex items-center gap-2 text-sm text-neutral-400">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    {{.Username}}
                </div>
            </div>
        </div>
    </nav>
    
    <main class="max-w-6xl mx-auto px-4 py-8">
        {{block "content" .}}{{end}}
    </main>
    
    <footer class="fixed bottom-0 left-0 right-0 bg-neutral-900 border-t border-neutral-800 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
        <small class="text-neutral-400">
            Auto-refresh: {{.RefreshMinutes}} min | 
            <span hx-get="/api/status" hx-trigger="every 30s" hx-swap="innerHTML">
                Connected
            </span>
        </small>
        <a href="https://github.com/PatrickWalther/twitch-miner-go" target="_blank" rel="noopener" title="View on GitHub" class="text-neutral-400 hover:text-purple-400 transition-colors">
            <svg class="w-6 h-6" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
            </svg>
        </a>
        {{if .Version}}<small class="text-neutral-400">{{.Version}}</small>{{end}}
        </div>
    </footer>
    
    {{block "scripts" .}}{{end}}
    
    <script>
        (function() {
            const overlay = document.getElementById('status-overlay');
            const title = document.getElementById('status-title');
            const content = document.getElementById('status-content');
            const message = document.getElementById('status-message');
            const spinner = document.getElementById('status-spinner');
            
            function updateStatus(status) {
                if (status.status === 'running') {
                    overlay.classList.add('hidden');
                    const reloadKey = 'miner_loaded_' + window.location.pathname;
                    if (!sessionStorage.getItem(reloadKey)) {
                        sessionStorage.setItem(reloadKey, 'true');
                        window.location.reload();
                    }
                    return;
                }
                
                sessionStorage.removeItem('miner_loaded_' + window.location.pathname);
                
                overlay.classList.remove('hidden');
                
                switch (status.status) {
                    case 'initializing':
                        title.textContent = 'Initializing...';
                        content.innerHTML = '';
                        message.textContent = status.message || 'Starting up...';
                        spinner.style.display = 'block';
                        break;
                        
                    case 'auth_required':
                        title.textContent = 'Twitch Login Required';
                        spinner.style.display = 'none';
                        if (status.auth) {
                            content.innerHTML = `
                                <p class="text-neutral-400">Open <a href="${status.auth.verificationUri}" target="_blank" class="text-purple-500 font-medium">${status.auth.verificationUri}</a></p>
                                <p class="text-neutral-400 mt-2">Enter this code:</p>
                                <div class="font-mono text-3xl font-bold text-purple-500 bg-neutral-900 px-6 py-4 rounded-lg my-4 tracking-widest select-all">${status.auth.userCode}</div>
                                <p class="text-neutral-400 text-sm">Code expires in ${Math.floor(status.auth.expiresIn / 60)} minutes</p>
                            `;
                        }
                        message.textContent = 'Waiting for authorization...';
                        break;
                        
                    case 'loading_streamers':
                        title.textContent = 'Loading Streamers';
                        content.innerHTML = status.streamerInfo ? `<p class="text-neutral-400">Loading: <strong class="text-neutral-100">${status.streamerInfo}</strong></p>` : '';
                        message.textContent = status.message || 'Please wait...';
                        spinner.style.display = 'block';
                        break;
                        
                    case 'error':
                        title.textContent = 'Error';
                        content.innerHTML = '';
                        message.textContent = status.message || 'An error occurred';
                        spinner.style.display = 'none';
                        break;
                }
            }
            
            fetch('/api/miner-status')
                .then(r => r.json())
                .then(updateStatus)
                .catch(() => {});
            
            let evtSource = null;
            
            function connectSSE() {
                if (evtSource) return;
                evtSource = new EventSource('/api/miner-status/stream');
                evtSource.onmessage = function(event) {
                    try {
                        const status = JSON.parse(event.data);
                        updateStatus(status);
                    } catch (e) {}
                };
                evtSource.onerror = function() {
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 5000);
                };
            }
            
            function disconnectSSE() {
                if (evtSource) {
                    evtSource.close();
                    evtSource = null;
                }
            }
            
            connectSSE();
            
            window.addEventListener('pagehide', disconnectSSE);
            window.addEventListener('beforeunload', disconnectSSE);
        })();
    </script>
</body>
</html>
